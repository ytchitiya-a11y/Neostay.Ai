<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
</head>

<body class="bg-gray-100">

<!-- ================= LOGIN SCREEN ================= -->
<div id="loginSection" class="flex items-center justify-center h-screen">
  <div class="bg-white p-8 rounded-xl shadow w-96">
    <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
    <input id="email" type="email" placeholder="Email" class="w-full p-3 border rounded mb-4">
    <input id="password" type="password" placeholder="Password" class="w-full p-3 border rounded mb-4">
    <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded">Login</button>
    <p id="loginError" class="text-red-500 mt-3 hidden">Invalid Login</p>
  </div>
</div>

<!-- ================= ADMIN PANEL ================= -->
<div id="adminPanel" class="hidden p-6">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Admin Panel</h1>
    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
  </div>

  <!-- Navigation -->
  <div class="space-x-4 mb-6">
    <button onclick="showSection('dashboard')" class="bg-gray-800 text-white px-4 py-2 rounded">Dashboard</button>
    <button onclick="showSection('addClient')" class="bg-blue-600 text-white px-4 py-2 rounded">Add Client</button>
    <button onclick="showSection('clientList')" class="bg-green-600 text-white px-4 py-2 rounded">Client List</button>
  </div>

  <!-- ================= DASHBOARD ================= -->
  <div id="dashboard" class="section">
    <div class="grid grid-cols-4 gap-6">
      <div class="bg-white p-6 rounded shadow">
        <h3>Total Clients</h3>
        <p id="totalClients" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3>Active Clients</h3>
        <p id="activeClients" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3>Expired Clients</h3>
        <p id="expiredClients" class="text-2xl font-bold text-red-600">0</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3>Revenue</h3>
        <p id="revenueSpan" class="text-2xl font-bold text-yellow-700">$0</p>
      </div>
    </div>
  </div>

  <!-- ================= ADD CLIENT ================= -->
  <div id="addClient" class="section hidden bg-white p-6 rounded shadow max-w-xl">
    <h2 class="text-xl font-bold mb-4">Add Client</h2>
    <input id="businessName" placeholder="Business Name" class="w-full p-3 border rounded mb-3">
    <input id="whatsapp" placeholder="WhatsApp Number" class="w-full p-3 border rounded mb-3">
    <textarea id="businessInfo" placeholder="Business Info" class="w-full p-3 border rounded mb-3"></textarea>
    <textarea id="customPrompt" placeholder="Custom Prompt" class="w-full p-3 border rounded mb-3"></textarea>
    <select id="planType" class="w-full p-3 border rounded mb-3">
      <option>Basic</option>
      <option>Pro</option>
      <option>Premium</option>
    </select>
    <input id="messageLimit" type="number" placeholder="Message Limit" class="w-full p-3 border rounded mb-3">
    <button onclick="addClient()" class="bg-blue-600 text-white px-6 py-3 rounded">Save Client</button>
  </div>

  <!-- ================= CLIENT LIST ================= -->
  <div id="clientList" class="section hidden bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">Clients</h2>

    <div class="flex items-center mb-4 space-x-4">
      <input id="searchInput" type="text" placeholder="Search client..." class="p-2 border rounded" oninput="loadClients()">
      <select id="filterStatus" class="p-2 border rounded" onchange="loadClients()">
        <option value="All">All</option>
        <option value="Active">Active</option>
        <option value="Expired">Expired</option>
      </select>
    </div>

    <table class="w-full text-left">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2">Business</th>
          <th class="p-2">Plan</th>
          <th class="p-2">Messages Used</th>
          <th class="p-2">Status</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody id="clientTable"></tbody>
    </table>
  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ðŸ”‘ Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyCUeIklxbz6dq1vRdOveeZZl-9tdIhKuB4",
  authDomain: "testora-98f88.firebaseapp.com",
  projectId: "testora-98f88",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// âœ… Allowed Admin UIDs
const allowedAdmins = ["YOUR_ADMIN_UID_1", "YOUR_ADMIN_UID_2"];

// LOGIN
window.login = async function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (err) {
    document.getElementById("loginError").classList.remove("hidden");
  }
};

// LOGOUT
window.logout = async function() {
  await signOut(auth);
};

// NAVIGATION
window.showSection = function(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
};

// PLAN DURATION
function getPlanDuration(planType) {
  switch(planType) {
    case "Basic": return 1;
    case "Pro": return 3;
    case "Premium": return 6;
    default: return 1;
  }
}

// AUTH CHECK & MULTI-ADMIN
onAuthStateChanged(auth, (user) => {
  if (user) {
    if (!allowedAdmins.includes(user.uid)) {
      alert("Access Denied: You are not an admin");
      signOut(auth);
      return;
    }
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
    loadClients();
  } else {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
  }
});

// ADD CLIENT
window.addClient = async function() {
  await addDoc(collection(db, "clients"), {
    businessName: businessName.value,
    whatsapp: whatsapp.value,
    businessInfo: businessInfo.value,
    customPrompt: customPrompt.value,
    planType: planType.value,
    messageLimit: Number(messageLimit.value),
    messagesUsed: 0,
    status: "Active",
    expiryDate: new Date(new Date().setMonth(new Date().getMonth() + getPlanDuration(planType.value))).toISOString().split("T")[0]
  });
  alert("Client Added");
  loadClients();
};

// RENEW CLIENT
window.renewClient = async function(id, planType) {
  const months = getPlanDuration(planType);
  const newExpiry = new Date();
  newExpiry.setMonth(newExpiry.getMonth() + months);
  await updateDoc(doc(db, "clients", id), {
    expiryDate: newExpiry.toISOString().split("T")[0],
    messagesUsed: 0,
    status: "Active"
  });
  alert(`Client Renewed for ${months} month(s)`);
  loadClients();
};

// DISABLE CLIENT
window.disableClient = async function(id) {
  if (!confirm("Are you sure you want to disable this client?")) return;
  await updateDoc(doc(db, "clients", id), { status: "Expired" });
  alert("Client Disabled");
  loadClients();
};

// LOAD CLIENTS
async function loadClients() {
  const querySnapshot = await getDocs(collection(db, "clients"));
  const table = document.getElementById("clientTable");
  table.innerHTML = "";

  let total = 0, active = 0, expired = 0, revenue = 0;
  const today = new Date();
  const searchQuery = document.getElementById("searchInput")?.value?.toLowerCase() || "";
  const filterStatus = document.getElementById("filterStatus")?.value || "All";

  for (const docSnap of querySnapshot.docs) {
    const data = docSnap.data();

    // AUTO EXPIRE IF PAST DATE
    const expiry = new Date(data.expiryDate);
    if (expiry < today && data.status === "Active") {
      await updateDoc(doc(db, "clients", docSnap.id), { status: "Expired" });
      data.status = "Expired";
    }

    // AUTO DISABLE IF MESSAGE LIMIT REACHED
    if (data.messagesUsed >= data.messageLimit && data.status === "Active") {
      await updateDoc(doc(db, "clients", docSnap.id), { status: "Expired" });
      data.status = "Expired";
    }

    // FILTER
    if (filterStatus !== "All" && data.status !== filterStatus) continue;

    // SEARCH
    if (searchQuery && !data.businessName.toLowerCase().includes(searchQuery)) continue;

    // STATS
    total++;
    if (data.status === "Active") active++;
    else expired++;

    // REVENUE (example pricing)
    let price = 0;
    switch(data.planType){
      case "Basic": price=10; break;
      case "Pro": price=30; break;
      case "Premium": price=60; break;
    }
    revenue += price;

    // EXPIRY WARNING
    let warning = "";
    const diffDays = Math.ceil((expiry - today)/(1000*60*60*24));
    if (diffDays <= 7 && data.status==="Active") warning = `<span class="text-yellow-700 font-bold">âš  ${diffDays}d left</span>`;

    // RENEW BUTTON
    let renewBtn = "";
    if (data.status==="Expired") renewBtn = `<button onclick="renewClient('${docSnap.id}','${data.planType}')" class="bg-yellow-500 text-white px-3 py-1 rounded">Renew</button>`;

    table.innerHTML += `
      <tr class="border-t">
        <td class="p-2">${data.businessName} ${warning}</td>
        <td class="p-2">${data.planType}</td>
        <td class="p-2">${data.messagesUsed} / ${data.messageLimit}</td>
        <td class="p-2">${data.status}</td>
        <td class="p-2 space-x-2">${renewBtn} <button onclick="disableClient('${docSnap.id}')" class="bg-red-600 text-white px-3 py-1 rounded">Disable</button></td>
      </tr>
    `;
  }

  // UPDATE DASHBOARD
  totalClients.innerText = total;
  activeClients.innerText = active;
  expiredClients.innerText = expired;
  revenueSpan.innerText = "$" + revenue;
}
</script>
</body>
</html>
