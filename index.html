<!DOCTYPE html>
<html>
<head>
  <title>Premium Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { background: linear-gradient(135deg, #0f0c29, #1a0f3c, #120b2e); font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,0.08); }
    .fade-in { animation: fadeIn 0.6s ease-in-out; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(15px);} to{opacity:1;transform:translateY(0);} }
    .hover-glow:hover { box-shadow: 0 0 20px rgba(255,255,255,0.15); transform: scale(1.03); transition: all 0.3s; }
  </style>
</head>

<body class="text-white min-h-screen">

<!-- ================= LOGIN ================= -->
<div id="loginSection" class="flex items-center justify-center h-screen fade-in">
  <div class="glass p-10 rounded-3xl w-96 shadow-2xl">
    <h2 class="text-3xl font-bold mb-6 text-center text-purple-400">Admin Login</h2>
    <input id="email" type="email" placeholder="Email" class="w-full p-3 bg-black/40 rounded-lg mb-4 outline-none border border-purple-500/30 focus:border-purple-500">
    <input id="password" type="password" placeholder="Password" class="w-full p-3 bg-black/40 rounded-lg mb-6 outline-none border border-purple-500/30 focus:border-purple-500">
    <button onclick="login()" class="w-full bg-purple-600 hover:bg-purple-700 transition p-3 rounded-lg font-semibold">Login</button>
    <p id="loginError" class="text-red-400 mt-3 hidden text-center">Invalid Credentials</p>
  </div>
</div>

<!-- ================= ADMIN PANEL ================= -->
<div id="adminPanel" class="hidden p-8 fade-in">

  <!-- Header -->
  <div class="flex justify-between items-center mb-10">
    <h1 class="text-3xl font-bold text-purple-400 flex items-center gap-3"><i data-lucide="layout-dashboard"></i> Dashboard</h1>
    <div class="flex gap-3">
      <button onclick="openAddModal()" class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle"></i> Add Client</button>
      <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-5 py-2 rounded-lg">Logout</button>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="grid grid-cols-4 gap-6 mb-12">
    <div class="glass p-6 rounded-xl hover-glow">
      <div class="flex justify-between items-center"><h3>Total Clients</h3><i data-lucide="users" class="text-purple-400"></i></div>
      <p id="totalClients" class="text-3xl font-bold mt-4">0</p>
    </div>
    <div class="glass p-6 rounded-xl hover-glow">
      <div class="flex justify-between items-center"><h3>Active Clients</h3><i data-lucide="check-circle" class="text-green-400"></i></div>
      <p id="activeClients" class="text-3xl font-bold mt-4 text-green-400">0</p>
    </div>
    <div class="glass p-6 rounded-xl hover-glow">
      <div class="flex justify-between items-center"><h3>Expired Clients</h3><i data-lucide="x-circle" class="text-red-400"></i></div>
      <p id="expiredClients" class="text-3xl font-bold mt-4 text-red-400">0</p>
    </div>
    <div class="glass p-6 rounded-xl hover-glow">
      <div class="flex justify-between items-center"><h3>Revenue</h3><i data-lucide="dollar-sign" class="text-yellow-400"></i></div>
      <p id="revenueSpan" class="text-3xl font-bold mt-4 text-yellow-400">$0</p>
    </div>
  </div>

  <!-- Client Table -->
  <div class="glass p-6 rounded-xl mb-10">
    <div class="flex items-center mb-4 space-x-4">
      <input id="searchInput" type="text" placeholder="Search client..." class="p-2 border rounded w-full" oninput="loadClients()">
      <select id="filterStatus" class="p-2 border rounded" onchange="loadClients()">
        <option value="All">All</option>
        <option value="Active">Active</option>
        <option value="Expired">Expired</option>
      </select>
    </div>
    <table class="w-full text-left">
      <thead class="text-purple-400">
        <tr>
          <th class="p-3">Business</th>
          <th class="p-3">Plan</th>
          <th class="p-3">Usage</th>
          <th class="p-3">Status</th>
          <th class="p-3">Actions</th>
        </tr>
      </thead>
      <tbody id="clientTable"></tbody>
    </table>
  </div>
</div>

<!-- ================= ADD CLIENT MODAL ================= -->
<div id="addModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center">
  <div class="glass p-8 rounded-3xl w-[500px] fade-in">
    <h2 class="text-2xl font-bold mb-6 text-purple-400">Add Client</h2>
    <input id="businessName" placeholder="Business Name" class="w-full p-3 bg-black/40 rounded mb-3 border border-purple-500/30">
    <input id="whatsapp" placeholder="WhatsApp Number" class="w-full p-3 bg-black/40 rounded mb-3 border border-purple-500/30">
    <textarea id="businessInfo" placeholder="Business Info" class="w-full p-3 bg-black/40 rounded mb-3 border border-purple-500/30"></textarea>
    <textarea id="customPrompt" placeholder="Custom Prompt" class="w-full p-3 bg-black/40 rounded mb-3 border border-purple-500/30"></textarea>
    <select id="planType" class="w-full p-3 bg-black/40 rounded mb-3 border border-purple-500/30">
      <option>Basic</option>
      <option>Pro</option>
      <option>Premium</option>
    </select>
    <input id="messageLimit" type="number" placeholder="Message Limit" class="w-full p-3 bg-black/40 rounded mb-4 border border-purple-500/30">
    <div class="flex justify-end gap-3">
      <button onclick="closeAddModal()" class="bg-gray-600 px-4 py-2 rounded">Cancel</button>
      <button onclick="addClient()" class="bg-green-600 px-4 py-2 rounded">Save</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ðŸ”‘ Firebase Config
const firebaseConfig = { apiKey:"AIzaSyDgroRQXK30CO3Ip9_6g9IdetWIL6jh7Zk", authDomain:"aiinlo.firebaseapp.com", projectId:"aiinlo" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const allowedAdmins = ["kR4P3KBngiaXEwHtAhZM1RHdutp1","YOUR_ADMIN_UID_2"];

// LOGIN / LOGOUT
window.login = async()=>{ try{ await signInWithEmailAndPassword(auth,email.value,password.value);} catch{loginError.classList.remove("hidden");} };
window.logout = async()=>{ await signOut(auth); };
onAuthStateChanged(auth,(user)=>{ 
  if(user){ if(!allowedAdmins.includes(user.uid)){ alert("Access Denied"); signOut(auth); return; } loginSection.classList.add("hidden"); adminPanel.classList.remove("hidden"); loadClients(); lucide.createIcons(); } 
  else{ loginSection.classList.remove("hidden"); adminPanel.classList.add("hidden"); } 
});

// MODAL
window.openAddModal=()=>addModal.classList.remove("hidden");
window.closeAddModal=()=>addModal.classList.add("hidden");

// PLAN DURATION
function getPlanDuration(plan){ return plan==="Basic"?1:plan==="Pro"?3:6; }

// ADD CLIENT
window.addClient=async()=>{
  const expiry=new Date(); expiry.setMonth(expiry.getMonth()+getPlanDuration(planType.value));
  await addDoc(collection(db,"clients"),{
    businessName:businessName.value, whatsapp:whatsapp.value, businessInfo:businessInfo.value, customPrompt:customPrompt.value,
    planType:planType.value, messageLimit:Number(messageLimit.value), messagesUsed:0, status:"Active", expiryDate:expiry.toISOString().split("T")[0]
  });
  closeAddModal(); loadClients();
};

// RENEW
window.renewClient=async(id,plan)=>{
  const expiry=new Date(); expiry.setMonth(expiry.getMonth()+getPlanDuration(plan));
  await updateDoc(doc(db,"clients",id),{expiryDate:expiry.toISOString().split("T")[0], messagesUsed:0, status:"Active"});
  loadClients();
};

// DISABLE
window.disableClient=async(id)=>{ if(!confirm("Disable this client?")) return; await updateDoc(doc(db,"clients",id),{status:"Expired"}); loadClients(); };

// LOAD CLIENTS
async function loadClients(){
  const snapshot=await getDocs(collection(db,"clients"));
  clientTable.innerHTML=""; let total=0,active=0,expired=0,revenue=0;
  const today=new Date(),search=document.getElementById("searchInput")?.value?.toLowerCase()||"",filter=document.getElementById("filterStatus")?.value||"All";

  for(const docSnap of snapshot.docs){
    const d=docSnap.data(); const id=docSnap.id;
    const expiry=new Date(d.expiryDate);

    if(expiry<today && d.status==="Active"){ await updateDoc(doc(db,"clients",id),{status:"Expired"}); d.status="Expired"; }
    if(d.messagesUsed>=d.messageLimit && d.status==="Active"){ await updateDoc(doc(db,"clients",id),{status:"Expired"}); d.status="Expired"; }

    if(filter!=="All"&&d.status!==filter) continue;
    if(search&& !d.businessName.toLowerCase().includes(search)) continue;

    total++; if(d.status==="Active") active++; else expired++;
    revenue+= d.planType==="Basic"?10:d.planType==="Pro"?30:60;

    const diff=Math.ceil((expiry-today)/(1000*60*60*24));
    const warning=(diff<=7 && d.status==="Active")?`<span class="text-yellow-400 font-bold">âš  ${diff}d left</span>`:"";
    const renewBtn=(d.status==="Expired")?`<button onclick="renewClient('${id}','${d.planType}')" class="bg-yellow-500 text-white px-3 py-1 rounded">Renew</button>`:"";

    clientTable.innerHTML+=`
      <tr class="border-t border-purple-500/20 hover:bg-purple-900/20 transition">
        <td class="p-2">${d.businessName} ${warning}</td>
        <td class="p-2">${d.planType}</td>
        <td class="p-2">${d.messagesUsed}/${d.messageLimit}</td>
        <td class="p-2">${d.status}</td>
        <td class="p-2 space-x-2">${renewBtn}<button onclick="disableClient('${id}')" class="bg-red-600 text-white px-3 py-1 rounded">Disable</button></td>
      </tr>`;
  }

  totalClients.innerText=total; activeClients.innerText=active; expiredClients.innerText=expired; revenueSpan.innerText="$"+revenue;
}
</script>
</body>
</html>
