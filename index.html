<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
</head>

<body class="bg-gray-100">

<!-- ================= LOGIN SCREEN ================= -->

<div id="loginSection" class="flex items-center justify-center h-screen">
  <div class="bg-white p-8 rounded-xl shadow w-96">
    <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>

    <input id="email" type="email" placeholder="Email"
      class="w-full p-3 border rounded mb-4">

    <input id="password" type="password" placeholder="Password"
      class="w-full p-3 border rounded mb-4">

    <button onclick="login()" 
      class="w-full bg-blue-600 text-white py-3 rounded">
      Login
    </button>

    <p id="loginError" class="text-red-500 mt-3 hidden">
      Invalid Login
    </p>
  </div>
</div>

<!-- ================= ADMIN PANEL ================= -->

<div id="adminPanel" class="hidden p-6">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Admin Panel</h1>
    <button onclick="logout()" 
      class="bg-red-600 text-white px-4 py-2 rounded">
      Logout
    </button>
  </div>

  <!-- Navigation -->
  <div class="space-x-4 mb-6">
    <button onclick="showSection('dashboard')" class="bg-gray-800 text-white px-4 py-2 rounded">Dashboard</button>
    <button onclick="showSection('addClient')" class="bg-blue-600 text-white px-4 py-2 rounded">Add Client</button>
    <button onclick="showSection('clientList')" class="bg-green-600 text-white px-4 py-2 rounded">Client List</button>
  </div>

  <!-- ================= DASHBOARD ================= -->

  <div id="dashboard" class="section">
    <div class="grid grid-cols-3 gap-6">
      <div class="bg-white p-6 rounded shadow">
        <h3>Total Clients</h3>
        <p id="totalClients" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3>Active Clients</h3>
        <p id="activeClients" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h3>Expired Clients</h3>
        <p id="expiredClients" class="text-2xl font-bold text-red-600">0</p>
      </div>
    </div>
  </div>

  <!-- ================= ADD CLIENT ================= -->

  <div id="addClient" class="section hidden bg-white p-6 rounded shadow max-w-xl">
    <h2 class="text-xl font-bold mb-4">Add Client</h2>

    <input id="businessName" placeholder="Business Name"
      class="w-full p-3 border rounded mb-3">

    <input id="whatsapp" placeholder="WhatsApp Number"
      class="w-full p-3 border rounded mb-3">

    <textarea id="businessInfo" placeholder="Business Info"
      class="w-full p-3 border rounded mb-3"></textarea>

    <textarea id="customPrompt" placeholder="Custom Prompt"
      class="w-full p-3 border rounded mb-3"></textarea>

    <input id="planType" placeholder="Plan Type"
      class="w-full p-3 border rounded mb-3">

    <input id="messageLimit" type="number" placeholder="Message Limit"
      class="w-full p-3 border rounded mb-3">

    <button onclick="addClient()" 
      class="bg-blue-600 text-white px-6 py-3 rounded">
      Save Client
    </button>
  </div>

  <!-- ================= CLIENT LIST ================= -->

  <div id="clientList" class="section hidden bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">Clients</h2>
    <table class="w-full text-left">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2">Business</th>
          <th class="p-2">Plan</th>
          <th class="p-2">Messages Used</th>
          <th class="p-2">Status</th>
        </tr>
      </thead>
      <tbody id="clientTable"></tbody>
    </table>
  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
   apiKey: "AIzaSyBsAEpp3hooCCHYEdmTNqTId9aWK0a69Ms",
  authDomain: "ai-vit-52666.firebaseapp.com",
  projectId: "ai-vit-52666",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= PLAN DURATION ================= */

function getPlanDuration(planType) {
  switch(planType) {
    case "Basic": return 1;
    case "Pro": return 3;
    case "Premium": return 6;
    default: return 1;
  }
}

/* ================= LOGIN ================= */
/* ================= LOGIN ================= */

window.login = async function() {
  try {
    const emailValue = document.getElementById("email").value;
    const passwordValue = document.getElementById("password").value;

    const userCredential = await signInWithEmailAndPassword(auth, emailValue, passwordValue);

    console.log("Logged in:", userCredential.user.email);
    document.getElementById("loginError").classList.add("hidden"); // hide error if successful

  } catch (error) {
    console.error("Login Error:", error);
    alert(error.message); // shows why login failed
    document.getElementById("loginError").classList.remove("hidden");
  }
};

window.logout = async function() {
  try {
    await signOut(auth);
    console.log("Logged out");
  } catch (error) {
    console.error("Logout Error:", error);
  }
};

onAuthStateChanged(auth, (user) => {
  if (user) {
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
    loadClients();
  } else {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
  }
});


/* ================= ADD CLIENT ================= */

window.addClient = async function() {

  const months = getPlanDuration(planType.value);
  const expiry = new Date();
  expiry.setMonth(expiry.getMonth() + months);

  await addDoc(collection(db, "clients"), {
    businessName: businessName.value,
    whatsapp: whatsapp.value,
    businessInfo: businessInfo.value,
    customPrompt: customPrompt.value,
    planType: planType.value,
    messageLimit: Number(messageLimit.value),
    messagesUsed: 0,
    status: "Active",
    expiryDate: expiry.toISOString().split("T")[0]
  });

  alert("Client Added");
  loadClients();
};

/* ================= LOAD CLIENTS ================= */

async function loadClients() {

  const querySnapshot = await getDocs(collection(db, "clients"));
  const table = document.getElementById("clientTable");
  table.innerHTML = "";

  let total = 0, active = 0, expired = 0;

  for (const documentSnapshot of querySnapshot.docs) {

    const data = documentSnapshot.data();
    const id = documentSnapshot.id;

    // ðŸ”¥ AUTO EXPIRE CHECK
    const today = new Date();
    const expiry = new Date(data.expiryDate);

    if (expiry < today && data.status === "Active") {
      await updateDoc(doc(db, "clients", id), { status: "Expired" });
      data.status = "Expired";
    }

    total++;
    if (data.status === "Active") active++;
    else expired++;

    // ðŸ”¥ Show Renew Only If Expired
    let renewBtn = "";
    if (data.status === "Expired") {
      renewBtn = `
        <button onclick="renewClient('${id}', '${data.planType}')" 
          class="bg-yellow-500 text-white px-3 py-1 rounded">
          Renew
        </button>
      `;
    }
table.innerHTML += `
  <tr class="border-t">
    <td class="p-2">${data.businessName}</td>
    <td class="p-2">${data.planType}</td>
    <td class="p-2">${data.expiryDate || "-"}</td>
    <td class="p-2">${data.messagesUsed} / ${data.messageLimit}</td>
    <td class="p-2">${data.status}</td>
    <td class="p-2 space-x-2">
      ${renewBtn}
      <button onclick="disableClient('${id}')" 
        class="bg-red-600 text-white px-3 py-1 rounded">
        Disable
      </button>
    </td>
  </tr>
`;
   

  totalClients.innerText = total;
  activeClients.innerText = active;
  expiredClients.innerText = expired;
}

/* ================= RENEW CLIENT ================= */

window.renewClient = async function(id, planType) {

  const months = getPlanDuration(planType);
  const newExpiry = new Date();
  newExpiry.setMonth(newExpiry.getMonth() + months);

  await updateDoc(doc(db, "clients", id), {
    expiryDate: newExpiry.toISOString().split("T")[0],
    messagesUsed: 0,
    status: "Active"
  });

  alert("Client Renewed");
  loadClients();
};

/* ================= DISABLE CLIENT ================= */

window.disableClient = async function(id) {

  const confirmAction = confirm("Are you sure you want to disable this client?");
  if (!confirmAction) return;

  await updateDoc(doc(db, "clients", id), {
    status: "Expired"
  });

  alert("Client Disabled");
  loadClients();
};

/* ================= NAVIGATION ================= */

window.showSection = function(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
};

</script>

</body>
</html>  
